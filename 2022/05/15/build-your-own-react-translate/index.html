<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>[è¯‘] Build your own React | æ˜¨æ—¥çš„é­”å¥³</title><meta name="keywords" content="React"><meta name="author" content="ä¸åœ†"><meta name="copyright" content="ä¸åœ†"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Build your own Reactæœ¬æ–‡ç¿»è¯‘è‡ªåšæ–‡ Build your own React ï¼ŒåŸä½œè€…ä¸º Rodrigo Pomboï¼Œå·²è·å¾—ä½œè€…æˆæƒã€‚ ç¬¬é›¶æ­¥ï¼šå›é¡¾ JSX to JSé¦–å…ˆæˆ‘ä»¬å…ˆé€šè¿‡ä»¥ä¸‹ä¸‰è¡Œä»£ç æ¥å›é¡¾ä¸€äº› React ä¸­çš„åŸºæœ¬æ¦‚å¿µã€‚ const element &#x3D; &lt;h1 title&#x3D;&quot;foo&quot;&gt;Hello&lt;&#x2F;h1&gt;const con">
<meta property="og:type" content="article">
<meta property="og:title" content="[è¯‘] Build your own React">
<meta property="og:url" content="https://ltanfr.github.io/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/index.html">
<meta property="og:site_name" content="æ˜¨æ—¥çš„é­”å¥³">
<meta property="og:description" content="Build your own Reactæœ¬æ–‡ç¿»è¯‘è‡ªåšæ–‡ Build your own React ï¼ŒåŸä½œè€…ä¸º Rodrigo Pomboï¼Œå·²è·å¾—ä½œè€…æˆæƒã€‚ ç¬¬é›¶æ­¥ï¼šå›é¡¾ JSX to JSé¦–å…ˆæˆ‘ä»¬å…ˆé€šè¿‡ä»¥ä¸‹ä¸‰è¡Œä»£ç æ¥å›é¡¾ä¸€äº› React ä¸­çš„åŸºæœ¬æ¦‚å¿µã€‚ const element &#x3D; &lt;h1 title&#x3D;&quot;foo&quot;&gt;Hello&lt;&#x2F;h1&gt;const con">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/build-your-own-react.jpg">
<meta property="article:published_time" content="2022-05-15T08:17:23.000Z">
<meta property="article:modified_time" content="2022-05-29T13:27:56.537Z">
<meta property="article:author" content="ä¸åœ†">
<meta property="article:tag" content="React">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/build-your-own-react.jpg"><link rel="shortcut icon" href="/blog-hexo-butterfly/img/favicon.png"><link rel="canonical" href="https://ltanfr.github.io/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/"><link rel="preconnect" href="//fastly.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/css/index.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/blog-hexo-butterfly/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: {"limitCount":50,"languages":{"author":"ä½œè€…: ä¸åœ†","link":"é“¾æ¥: ","source":"æ¥æº: æ˜¨æ—¥çš„é­”å¥³","info":"è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“","cht_to_chs":"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“","day_to_night":"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://fastly.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '[è¯‘] Build your own React',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-05-29 21:27:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"  media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/css/universe.css"  media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.0.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/avatar.jpeg" onerror="onerror=null;src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/blog-hexo-butterfly/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">9</div></a><a href="/blog-hexo-butterfly/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/blog-hexo-butterfly/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog-hexo-butterfly/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-compass"></i><span> ç›®å½•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/blog-hexo-butterfly/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶è½´</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> é£Ÿç²®</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/blog-hexo-butterfly/books/"><i class="fa-fw fa-solid fa-book"></i><span> ä¹¦å †</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/movies/"><i class="fa-fw fas fa-video"></i><span> æ˜ ç”»</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/bangumis/"><i class="fa-fw fa-solid fa-ghost"></i><span> ç•ªå‰§</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog-hexo-butterfly/about/"><i class="fa-fw fa-solid fa-hurricane"></i><span> å…³äºæˆ‘</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/build-your-own-react.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/blog-hexo-butterfly/">æ˜¨æ—¥çš„é­”å¥³</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog-hexo-butterfly/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa-solid fa-compass"></i><span> ç›®å½•</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/blog-hexo-butterfly/archives/"><i class="fa-fw fas fa-archive"></i><span> æ—¶è½´</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> é£Ÿç²®</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/blog-hexo-butterfly/books/"><i class="fa-fw fa-solid fa-book"></i><span> ä¹¦å †</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/movies/"><i class="fa-fw fas fa-video"></i><span> æ˜ ç”»</span></a></li><li><a class="site-page child" href="/blog-hexo-butterfly/bangumis/"><i class="fa-fw fa-solid fa-ghost"></i><span> ç•ªå‰§</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/blog-hexo-butterfly/about/"><i class="fa-fw fa-solid fa-hurricane"></i><span> å…³äºæˆ‘</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">[è¯‘] Build your own React</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-05-15T08:17:23.000Z" title="å‘è¡¨äº 2022-05-15 16:17:23">2022-05-15</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-05-29T13:27:56.537Z" title="æ›´æ–°äº 2022-05-29 21:27:56">2022-05-29</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog-hexo-butterfly/categories/%E5%89%8D%E7%AB%AF/">å‰ç«¯</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog-hexo-butterfly/categories/%E5%89%8D%E7%AB%AF/React/">React</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog-hexo-butterfly/categories/%E7%BF%BB%E8%AF%91/">ç¿»è¯‘</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">8.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>35åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="[è¯‘] Build your own React"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Build-your-own-React"><a href="#Build-your-own-React" class="headerlink" title="Build your own React"></a>Build your own React</h1><p>æœ¬æ–‡ç¿»è¯‘è‡ªåšæ–‡ <strong><a target="_blank" rel="noopener" href="https://pomb.us/build-your-own-react/">Build your own React</a></strong> ï¼ŒåŸä½œè€…ä¸º <a target="_blank" rel="noopener" href="https://pomb.us/">Rodrigo Pombo</a>ï¼Œå·²è·å¾—ä½œè€…æˆæƒã€‚</p>
<h1 id="ç¬¬é›¶æ­¥ï¼šå›é¡¾-JSX-to-JS"><a href="#ç¬¬é›¶æ­¥ï¼šå›é¡¾-JSX-to-JS" class="headerlink" title="ç¬¬é›¶æ­¥ï¼šå›é¡¾ JSX to JS"></a>ç¬¬é›¶æ­¥ï¼šå›é¡¾ JSX to JS</h1><p>é¦–å…ˆæˆ‘ä»¬å…ˆé€šè¿‡ä»¥ä¸‹ä¸‰è¡Œä»£ç æ¥å›é¡¾ä¸€äº› <code>React</code> ä¸­çš„åŸºæœ¬æ¦‚å¿µã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">title</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€è¡Œä»£ç å®šä¹‰äº†ä¸€ä¸ª<code>React</code>å…ƒç´ ã€‚</p>
<p>ç¬¬äºŒè¡Œä»£ç ä»<code>DOM</code>ä¸­è·å–äº†<code>id</code>ä¸º<code>root</code>çš„å…ƒç´ ã€‚</p>
<p>ç¬¬ä¸‰è¡Œä»£ç å°†ç¬¬ä¸€è¡Œå®šä¹‰çš„<code>React</code>å…ƒç´ æ¸²æŸ“åˆ°ç¬¬äºŒè¡Œè·å–åˆ°çš„å…ƒç´ ä¸­å»ã€‚</p>
<p>ä»¥ä¸Šä¸‰è¡Œä»£ç å°±æ„æˆäº†ä¸€ä¸ªéå¸¸ç®€å•çš„<code>React App</code>ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•é€šè¿‡åŸç”Ÿçš„<code>JS</code>æ¥ä»£æ›¿ä»¥ä¸Šä¸‰è¡Œä»£ç ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">title</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€è¡Œä»£ç ï¼Œå…¶ä¸­çš„<code>React</code>å…ƒç´ å°±æ˜¯é€šè¿‡<code>js</code>æ¥å®šä¹‰çš„ï¼Œå®ƒç”šè‡³ä¸æ˜¯åˆæ³•çš„<code>JS</code>è¯­æ³•ï¼Œä¸ºäº†ç”¨åŸç”Ÿçš„<code>JS</code>æ¥æ›¿ä»£å®ƒï¼Œé¦–å…ˆæˆ‘ä»¬å¾—è®©å®ƒå˜å¾—åˆæ³•ã€‚</p>
<p>JSXåˆ°JSåˆ°è½¬æ¢æ˜¯é€šè¿‡åƒ<a target="_blank" rel="noopener" href="https://babeljs.io/">Babel</a>è¿™æ ·çš„å·¥å…·æ¥å®ç°çš„ï¼Œè½¬æ¢è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼šæŠŠ<code>js</code>è¯­æ³•ä¸­çš„æ ‡ç­¾<code>tag</code>ã€å±æ€§<code>props</code>ã€å­å…ƒç´ <code>children</code>ä½œä¸ºå‚æ•°ä¼ å…¥ä¸€ä¸ªå«åš<code>createElement</code>çš„å‡½æ•°æ¥å¤„ç†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  <span class="string">&quot;Hello&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>React.createElement</code>è¿™ä¸ªæ–¹æ³•é€šè¿‡ä¼ å…¥çš„å‚æ•°åˆ›å»ºäº†ä¸€ä¸ªå¯¹è±¡ã€‚æŠ›å¼€è¿™ä¸ªæ–¹æ³•ä¼šå¯¹å‚æ•°çš„ä¸€äº›éªŒè¯ä»¥å¤–ï¼Œè¿™å°±æ˜¯å®ƒæ‰€åšçš„å…¨éƒ¨äº‹æƒ…ã€‚ä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•æ¨¡ä»¿ä¸€ä¸‹<code>React.createElement</code>åˆ›å»ºçš„å¯¹è±¡ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰€å®šä¹‰çš„å…ƒç´ æ˜¯ä¸€ä¸ªå…·æœ‰ä¸¤ä¸ªå±æ€§ï¼ˆ<code>type</code>å’Œ<code>props</code>ï¼‰çš„å¯¹è±¡ï¼ˆå½“ç„¶çœŸæ­£çš„<code>ReactElement</code>å¯ä¸æ­¢è¿™ä¸¤ä¸ªå±æ€§ï¼Œä¸è¿‡åœ¨è¿™é‡Œæˆ‘ä»¬åªå…³å¿ƒè¿™ä¸¤ä¸ªï¼‰ã€‚</p>
<p><code>type</code>æŒ‡çš„æ˜¯æˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„<code>DOM</code>å…ƒç´ ç±»å‹çš„å­—ç¬¦ä¸²ï¼Œç­‰åŒäºé€šè¿‡<code>document.createElement</code>æ–¹æ³•æ¥åˆ›å»º<code>DOM</code>å…ƒç´ æ—¶ä¼ å…¥çš„<code>tagName</code>ã€‚<code>type</code>ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä½†æ˜¯ä¸ºäº†ä¸é€ æˆå›°æƒ‘ï¼Œè¿™ä¸ªç­‰åˆ°ç¬¬ä¸ƒæ­¥æ—¶æˆ‘ä»¬å†è¯´ã€‚ </p>
<p><code>props</code>ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒå­˜æ”¾çš„æ˜¯JSXä¸­è®¾ç½®çš„ç‰¹æ€§ï¼ˆ<code>attributes</code>ï¼‰çš„é”®ä¸å€¼ï¼Œä»¥åŠä¸€ä¸ªç‰¹æ®Šçš„å±æ€§ï¼ˆ<code>property</code>ï¼‰<code>children</code>ã€‚</p>
<p><code>children</code>åœ¨è¿™é‡Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸è¿‡æ›´å¤šæ—¶å€™å®ƒä¼šæ˜¯ä¸€ä¸ªåŒ…å«è®¸å¤šå…ƒç´ çš„æ•°ç»„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼—å¤šçš„å…ƒç´ é€šè¿‡é”™ç»¼å¤æ‚çš„å…³ç³»èƒ½å¤Ÿæ„å»ºæˆæ ‘çš„åŸå› ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>å¦å¤–æˆ‘ä»¬éœ€è¦æ¥å¤„ç†çš„ä¸€ä¸ªæ–¹æ³•æ˜¯<code>ReactDOM.render</code>ã€‚<code>render</code>æ˜¯<code>React</code>æ¥æ”¹å˜<code>DOM</code>çš„æ–¹æ³•ï¼Œè¿™æ ·ç®€å•çš„ä¸€å¥æè¿°æœ‰äº›è¿‡äºå®½æ³›äº†ï¼Œä¸è¿‡æˆ‘ä»¬å…ˆå¯ä»¥æ ¹æ®è¿™ç‚¹æ¥è¯•ç€æ£é¼“æ£é¼“å®ƒæ˜¯æ€ä¹ˆæ”¹å˜<code>DOM</code>çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line">node[<span class="string">&quot;title&quot;</span>] = element.<span class="property">props</span>.<span class="property">title</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæˆ‘ä»¬æ ¹æ®æˆ‘ä»¬åˆ›å»ºçš„<code>element</code>çš„å±æ€§<code>type</code>æ¥åˆ›å»ºå¯¹åº”çš„<code>DOM</code>èŠ‚ç‚¹ï¼Œåœ¨è¿™é‡Œæ˜¯<code>h1</code>ã€‚ç„¶åæˆ‘ä»¬æ ¹æ®<strong>å…ƒç´ </strong><code>element</code>çš„å±æ€§ä¸ºåˆ›å»ºçš„<strong>èŠ‚ç‚¹</strong>è®¾ç½®å±æ€§ï¼Œåœ¨è¿™é‡Œæ˜¯<code>title</code>ã€‚</p>
<blockquote>
<p>ä¸ºäº†é¿å…å›°æ‰°ï¼Œåœ¨è¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼Œæ–‡ä¸­æ‰€è¯´çš„<strong>å…ƒç´ </strong>æŒ‡çš„æ˜¯<code>React Element</code>ï¼Œ<strong>èŠ‚ç‚¹</strong>æŒ‡çš„æ˜¯<code>DOM Element</code>ï¼Œä»¥æ­¤æ¥åŒºåˆ†ä¸¤è€…ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> text = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">text[<span class="string">&quot;nodeValue&quot;</span>] = element.<span class="property">props</span>.<span class="property">children</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æ¥ä¸ºå­å…ƒç´ åˆ›å»ºç›¸åº”çš„èŠ‚ç‚¹ã€‚è¿™é‡Œçš„è¯åªæœ‰ä¸€ä¸ªå­å…ƒç´ ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚ä¹‹æ‰€ä»¥é€‰æ‹©åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ï¼ˆ<code>textNode</code>ï¼‰è€Œä¸æ˜¯è®¾ç½®<code>innerText</code>å±æ€§ï¼Œæ˜¯å› ä¸ºè¿™æ ·åšçš„è¯ä¹‹åæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡åŒä¸€ç§æ–¹å¼æ¥å¤„ç†æ‰€æœ‰å…ƒç´ ã€‚</p>
<p>åŒæ—¶éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ä¸ºèŠ‚ç‚¹è®¾ç½®<code>nodeValue</code>å±æ€§çš„è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸è®¾ç½®èŠ‚ç‚¹<code>h1</code>è®¾ç½®<code>title</code>å±æ€§ç±»ä¼¼ï¼Œå°±åƒæ˜¯åœ¨è®¾ç½®ä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹çš„<code>nodeValue</code>ä¸º<code>Hello</code>ï¼Œå³<code>props: &#123;nodeValue: &quot;hello&quot;&#125;</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"></span><br><span class="line">node.<span class="title function_">appendChild</span>(text)</span><br><span class="line">container.<span class="title function_">appendChild</span>(node)</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬å°†åˆ›å»ºçš„æ–‡æœ¬èŠ‚ç‚¹æ”¾åˆ°èŠ‚ç‚¹<code>h1</code>ä¸Šï¼Œå°†èŠ‚ç‚¹<code>h1</code>æ”¾åˆ°<code>id</code>ä¸º<code>root</code>çš„èŠ‚ç‚¹ä¸Šå»ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ç”¨åŸç”Ÿçš„<code>JS</code>æ¥æ›¿ä»£<code>JSX</code>è¯­æ³•è¿™ä¸€ç›®æ ‡ï¼Œå®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="attr">children</span>: <span class="string">&quot;Hello&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> node = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line">node[<span class="string">&quot;title&quot;</span>] = element.<span class="property">props</span>.<span class="property">title</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> text = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">text[<span class="string">&quot;nodeValue&quot;</span>] = element.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line"></span><br><span class="line">node.<span class="title function_">appendChild</span>(text)</span><br><span class="line">container.<span class="title function_">appendChild</span>(node)</span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬ä¸€æ­¥ï¼šcreateElement"><a href="#ç¬¬ä¸€æ­¥ï¼šcreateElement" class="headerlink" title="ç¬¬ä¸€æ­¥ï¼šcreateElement"></a>ç¬¬ä¸€æ­¥ï¼šcreateElement</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">b</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>è®©æˆ‘ä»¬ä»å¦å¤–ä¸€ä¸ª<code>React App</code>å¼€å§‹ã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬æ¥å°è¯•åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„<code>React</code>æ¥æ›¿ä»£çœŸæ­£çš„<code>React</code>ã€‚</p>
<p>ä»å®ç°<code>createElement</code>æ–¹æ³•å¼€å§‹å§ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨JSX<code>è½¬æ¢åˆ°</code>JS<code>çš„è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹</code>createElement&#96;è¿™ä¸ªæ–¹æ³•åˆ°åº•éƒ½åšäº†äº›ä»€ä¹ˆå§ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** JSX */</span></span><br><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">b</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">/** JS */</span></span><br><span class="line"><span class="keyword">const</span> element = <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;bar&quot;</span>),</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢æˆ‘ä»¬æåˆ°è¿‡ï¼Œä¸€ä¸ªå…ƒç´ ï¼ˆæˆ‘ä»¬ç®€åŒ–è¿‡çš„ï¼‰å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¸¦æœ‰<code>type</code>å’Œ<code>props</code>è¿™ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ã€‚æˆ‘ä»¬çš„æ–¹æ³•å”¯ä¸€éœ€è¦æ“å¿ƒçš„å°±æ˜¯å¦‚ä½•å»åˆ›å»ºè¿™ä¸ªå¯¹è±¡ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type, props, ...children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      children,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä»¥ä¸Šä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å±•å¼€æ“ä½œç¬¦<code>...</code>æ¥å¤„ç†<code>props</code>ï¼Œä½¿ç”¨å‰©ä½™å‚æ•°è¯­æ³•<code>...</code>ï¼ˆæ²¡é”™ï¼Œè¿˜æ˜¯è¿™ä¸‰ä¸ªç‚¹ï¼Œéƒ½æ˜¯<code>ES6</code>è¯­æ³•ï¼‰æ¥å¤„ç†<code>children</code>ï¼Œç»è¿‡å‰©ä½™å‚æ•°è¯­æ³•çš„å¤„ç†ï¼Œ<code>children</code>å°±å˜æˆäº†ä¸€ä¸ªæ•°ç»„ã€‚</p>
<p>ä¾‹å¦‚ï¼Œ<code>createElement(&quot;div&quot;)</code>è¿”å›ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123; <span class="attr">children</span>: [] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createElement(&quot;div&quot;, null, a)</code>è¿”å›ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123; <span class="attr">children</span>: [a] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>createElement(&quot;div&quot;, null, a, b)</code>è¿”å›ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123; <span class="attr">children</span>: [a, b] &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>children</code>æ•°ç»„ä¸­çš„å…ƒç´ ä¸ä¸€å®šæ˜¯å¯¹è±¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯åŸå§‹ç±»å‹çš„å€¼å¦‚<code>number</code>æˆ–<code>string</code>ã€‚å¯¹äºè¿™ç§å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºä¸€ç§ç‰¹æ®Šçš„<code>type</code>ï¼š<code>TEXT_ELEMENT</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type, props, ...children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      <span class="attr">children</span>: children.<span class="title function_">map</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">        <span class="keyword">typeof</span> child === <span class="string">&quot;object&quot;</span></span><br><span class="line">          ? child</span><br><span class="line">          : <span class="title function_">createTextElement</span>(child)</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createTextElement</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;TEXT_ELEMENT&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">nodeValue</span>: text,</span><br><span class="line">      <span class="attr">children</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>éœ€è¦æ³¨æ„çœŸæ­£çš„<code>React</code>å¹¶æ²¡æœ‰å°è£…åŸå§‹ç±»å‹çš„å€¼æˆ–åœ¨æ²¡æœ‰<code>children</code>æ—¶åˆ›å»ºä¸€ä¸ªç©ºæ•°ç»„ï¼Œæˆ‘ä»¬è¿™æ ·åšæ˜¯ä¸ºäº†ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ˜“äºç†è§£ï¼Œè€Œä¸æ˜¯è¿½æ±‚é«˜æ€§èƒ½ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="title class_">React</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;bar&quot;</span>),</span><br><span class="line">  <span class="title class_">React</span>.<span class="title function_">createElement</span>(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ›¿æ¢<code>React.createElement</code>è¿™ä¸ªæ–¹æ³•</p>
<p>æ›¿æ¢<code>React</code>çš„ç¬¬ä¸€æ­¥ï¼Œç»™æˆ‘ä»¬çš„åº“å–ä¸ªåå­—å§ğŸ¤¨ã€‚</p>
<p>åå­—è¦å¬èµ·æ¥åƒ<code>React</code>ğŸ¤”ï¼ŒåŒæ—¶ä¹Ÿè¦æœ‰æ•™å­¦ï¼ˆ*<code>didactic</code>*ï¼‰çš„å‘³é“ğŸ§ã€‚</p>
<p>æœ‰äº†ğŸ’¡ï¼Œå°±å«å®ƒ<code>Didact</code>å§ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Didact</span> = &#123;</span><br><span class="line">  createElement,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> element = <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(</span><br><span class="line">  <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  &#123; <span class="attr">id</span>: <span class="string">&quot;foo&quot;</span> &#125;,</span><br><span class="line">  <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(<span class="string">&quot;a&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;bar&quot;</span>),</span><br><span class="line">  <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(<span class="string">&quot;b&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æˆ‘ä»¬ä»ç„¶éœ€è¦ä½¿ç”¨<code>JSX</code>è¯­æ³•ï¼Œæ€æ ·æ‰èƒ½è®©<code>babel</code>çŸ¥é“æˆ‘ä»¬ç”¨çš„æ˜¯<code>Didact</code>ä¸­çš„<code>createElement</code>æ–¹æ³•è€Œä¸æ˜¯<code>React</code>çš„å‘¢ï¼Ÿ</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> Didact.createElement */</span></span><br><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">b</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>åœ¨å…ƒç´ å‰é¢æ·»åŠ åƒè¿™æ ·çš„æ³¨é‡Šï¼Œ<code>babel</code>å°±ä¼šä½¿ç”¨æˆ‘ä»¬å®šä¹‰çš„æ–¹æ³•å»è½¬æ¢<code>JSX</code>äº†ã€‚ï¼ˆå…³äº<code>babel</code>çš„è§£æè§„åˆ™è¿™é‡Œå°±ä¸è¿‡å¤šæ·±å…¥ï¼‰</p>
<p>æœ€åï¼Œæœ¬èŠ‚å®ç°çš„<code>createElement</code>æ–¹æ³•å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type, props, ...children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      <span class="attr">children</span>: children.<span class="title function_">map</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">        <span class="keyword">typeof</span> child === <span class="string">&quot;object&quot;</span></span><br><span class="line">          ? child</span><br><span class="line">          : <span class="title function_">createTextElement</span>(child)</span><br><span class="line">      ),</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createTextElement</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;TEXT_ELEMENT&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">nodeValue</span>: text,</span><br><span class="line">      <span class="attr">children</span>: [],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬äºŒæ­¥ï¼šrender"><a href="#ç¬¬äºŒæ­¥ï¼šrender" class="headerlink" title="ç¬¬äºŒæ­¥ï¼šrender"></a>ç¬¬äºŒæ­¥ï¼šrender</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> Didact.createElement */</span></span><br><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;foo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">b</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œè®©æˆ‘ä»¬å…³æ³¨æœ€åä¸€è¡Œä»£ç ã€‚æ˜¯çš„æ²¡é”™ï¼Œæœ¬èŠ‚çš„ç›®æ ‡å°±æ˜¯å®ç°æˆ‘ä»¬è‡ªå·±çš„<code>render</code>æ–¹æ³•ä»¥æ›¿æ¢<code>ReactDOM.render</code>ã€‚</p>
<p>å¯¹äºç°åœ¨çš„æˆ‘ä»¬æ¥è¯´ï¼Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒæŠŠå…ƒç´ å˜æˆèŠ‚ç‚¹æ·»åŠ åˆ°<code>DOM</code>ä¸Šå»ã€‚è‡³äºæ›´æ–°å’Œåˆ é™¤ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œåé¢å†è€ƒè™‘è¿™äº›ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°±å…ˆæ­å¥½äº†æ¶å­ï¼Œæ¥ç€å°±åªéœ€è¦åœ¨<code>render</code>æ–¹æ³•å†…éƒ¨å»å®ç°å…·ä½“çš„åŠŸèƒ½å°±å¥½äº†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO create dom nodes</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Didact</span> = &#123;</span><br><span class="line">  createElement,</span><br><span class="line">  render,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Didact</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ ¹æ®å…ƒç´ çš„ç±»å‹<code>type</code>æ¥åˆ›å»ºç›¸åº”çš„<code>DOM</code>èŠ‚ç‚¹ï¼Œç„¶åå°†è¿™ä¸ªèŠ‚ç‚¹æ·»åŠ åˆ°å®¹å™¨èŠ‚ç‚¹<code>container</code>ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œä¸è¦å¿˜äº†å­å…ƒç´ <code>children</code>ï¼Œè¿™é‡Œé‡‡ç”¨é€’å½’çš„æ–¹æ³•æ¥å¤„ç†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç­‰ç­‰ï¼Œè¿˜æœ‰æ–‡æœ¬å…ƒç´ å‘¢ï¼Œå¦‚æœå…ƒç´ çš„ç±»å‹<code>type</code>æ˜¯<code>TEXT_ELEMENT</code>ï¼Œæˆ‘ä»¬è¦ä¸ºå…¶åˆ›å»ºæ–‡æœ¬èŠ‚ç‚¹ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼ŒèŠ‚ç‚¹æœ‰äº†ï¼Œå°±è¯¥ä¸ºå…¶æ·»åŠ å±æ€§<code>props</code>äº†ã€‚è®°å¾—éœ€è¦æ’é™¤<code>props</code>ä¸­çš„<code>children</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(element.<span class="property">props</span>)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = element.<span class="property">props</span>[name]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bingo! Thatâ€™s it! æˆ‘ä»¬åšåˆ°äº†ï¼Œç°åœ¨æˆ‘ä»¬çš„åº“<code>Didact</code> ä¹Ÿå¯ä»¥å°†<code>JSX</code>å…ƒç´ æ¸²æŸ“æˆçœŸæ­£çš„<code>DOM</code>èŠ‚ç‚¹äº†ã€‚</p>
<p>æœ¬èŠ‚å®ç°çš„<code>render</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(element.<span class="property">props</span>)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = element.<span class="property">props</span>[name]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ ä¸Šä¹‹å‰å®ç°çš„å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElement</span>(<span class="params">type, props, ...children</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      <span class="attr">children</span>: children.<span class="title function_">map</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">        <span class="keyword">typeof</span> child === <span class="string">&quot;object&quot;</span> ? child : <span class="title function_">createTextElement</span>(child)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createTextElement</span>(<span class="params">text</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="string">&quot;TEXT_ELEMENT&quot;</span>,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">nodeValue</span>: text,</span><br><span class="line">      <span class="attr">children</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span>;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(element.<span class="property">props</span>)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = element.<span class="property">props</span>[name];</span><br><span class="line">    &#125;);</span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span> <span class="title function_">render</span>(child, dom));</span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Didact</span> = &#123;</span><br><span class="line">  createElement,</span><br><span class="line">  render</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> Didact.createElement */</span></span><br><span class="line"><span class="keyword">const</span> element = (</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background: salmon&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span> <span class="attr">style</span>=<span class="string">&quot;text-align:right&quot;</span>&gt;</span>from Didact<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line"><span class="title class_">Didact</span>.<span class="title function_">render</span>(element, container);</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨<a target="_blank" rel="noopener" href="https://codesandbox.io/s/didact-2-k6rbj?file=/src/index.js:0-1113">codesandbox</a>ä¸Šçœ‹çœ‹æœ€ç»ˆçš„æ•ˆæœæ€ä¹ˆæ ·ã€‚</p>
<h1 id="ç¬¬ä¸‰æ­¥ï¼šConcurrent-Mode"><a href="#ç¬¬ä¸‰æ­¥ï¼šConcurrent-Mode" class="headerlink" title="ç¬¬ä¸‰æ­¥ï¼šConcurrent Mode"></a>ç¬¬ä¸‰æ­¥ï¼šConcurrent Mode</h1><p>å¹¶å‘ï¼Œå¬èµ·æ¥æ˜¯ä¸æ˜¯éå¸¸åœ°é«˜å¤§ä¸Šï¼Ÿæ²¡é”™ï¼Œæœ¬èŠ‚å°±æ˜¯è¦å®ç°å®ƒï¼</p>
<p>ä¸è¿‡ï¼Œåœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ¥è§£å†³ä¸€ç‚¹é—®é¢˜ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  </span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ä»¥ä¸Šä»£ç ï¼Œå› ä¸ºé‡‡ç”¨çš„æ˜¯é€’å½’ï¼Œä¸€æ—¦æˆ‘ä»¬å¼€å§‹æ¸²æŸ“ï¼Œåœ¨æ•´ä¸ªå…ƒç´ æ ‘æ¸²æŸ“çš„è¿‡ç¨‹æ˜¯æ— æ³•åœä¸‹æ¥çš„ã€‚å¦‚æœå…ƒç´ æ ‘éå¸¸å¤æ‚çš„è¯ï¼Œå°±ä¼šå ç”¨ä¸»çº¿ç¨‹éå¸¸å¤šçš„æ—¶é—´ï¼Œä»è€Œé€ æˆé˜»å¡ã€‚è¯•ç€æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæµè§ˆå™¨éœ€è¦å¤„ç†ä¼˜å…ˆçº§æ›´é«˜çš„äº‹ä»¶å¦‚ç”¨æˆ·è¾“å…¥ã€ä¿æŒåŠ¨ç”»æµç•…è¿è¡Œï¼Œè¿™æ—¶æµè§ˆå™¨å°±ä¸å¾—ä¸ç­‰åˆ°<code>render</code>æ–¹æ³•æ‰§è¡Œå®Œåå†æ¥å¤„ç†è¿™äº›äº‹æƒ…ã€‚</p>
<p>æ—¢ç„¶é€’å½’ä¼šé€ æˆè¿™ä¹ˆä¸¥é‡çš„é—®é¢˜ï¼Œé‚£æˆ‘ä»¬ä¹‹å‰ä¸ºä»€ä¹ˆè¦é‡‡ç”¨é€’å½’çš„æ–¹å¼å‘¢ï¼Ÿæˆ‘çŒœæ˜¯å› ä¸ºReactä¹‹å‰ä¹Ÿæ˜¯é‡‡ç”¨ä¸å¯ä¸­æ–­çš„é€’å½’çš„æ–¹å¼ã€‚ï¼ˆè¯¯</p>
<p>èµ°è¿œäº†ï¼Œè®©æˆ‘ä»¬å›åˆ°æ­£é¢˜ï¼Œæ¥å°†è¿™ä¸ªè¿‡ç¨‹å˜å¾—å¯ä¸­æ–­ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å°†æ•´ä¸ªä»»åŠ¡æ‹†åˆ†æˆä¸€ä¸ªä¸ªå°çš„ä»»åŠ¡å•å…ƒ<code>work unit</code>ï¼Œç„¶ååœ¨æ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå°çš„ä»»åŠ¡å•å…ƒåè¯¢é—®ä¸€ä¸‹æµè§ˆå™¨æœ‰æ²¡æœ‰å…¶ä»–éœ€è¦ä¼˜å…ˆå¤„ç†çš„äº‹æƒ…ã€‚è¿™ä¸ªåå¤çš„è¿‡ç¨‹æˆ‘ä»¬ç”¨<code>requestIdleCallback</code>è¿™ä¸ªåŸç”Ÿæ–¹æ³•æ¥å®ç°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™æ‰§è¡Œï¼Œè¿™æ ·çš„è¯åƒä¸€äº›å…³é”®äº‹ä»¶å¦‚åŠ¨ç”»å’Œç”¨æˆ·è¾“å…¥å°±ä¸ä¼šè¢«å½±å“å»¶è¿Ÿã€‚<code>requestIdleCallback</code>åŒæ—¶ä¹Ÿ<strong>æä¾›</strong>äº†ä¸€ä¸ªç±»ä¼¼äºæˆªæ­¢æ—¶é—´<code>deadline</code>çš„å‚æ•°ï¼Œå¦‚æœä¼ å…¥çš„æ–¹æ³•æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†è¿™ä¸ªæ—¶é—´ï¼Œå°±ä¼šåœæ­¢æ‰§è¡Œå°†ä¸»åŠ¨æƒäº¤è¿˜åˆ°æµè§ˆå™¨æ‰‹ä¸­ã€‚</p>
<blockquote>
<p>æ³¨æ„<code>React</code>ä¸å†ä½¿ç”¨<code>requestIdleCallback</code>è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºä»–ä»¬ä¸ºäº†ä¿è¯å…¼å®¹æ€§è‡ªå·±å®ç°äº†ä¸€å¥—ï¼ä¸è¿‡ä»æ–¹æ³•çš„æ¦‚å¿µä¸Šæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±é‡‡ç”¨<code>requestIdleCallback</code>è¿™ä¸ªæ–¹æ³•ã€‚</p>
</blockquote>
<p>åœ¨å¼€å§‹è¿™ä¸ªå¾ªç¯ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŒ‡å®šç¬¬ä¸€ä¸ªä»»åŠ¡å•å…ƒï¼Œä¸ºæ­¤æˆ‘ä»¬åˆ›å»ºäº†<code>performUnitOfWork</code>æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­éœ€è¦å»æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ï¼ŒåŒæ—¶æœ€åè¿”å›ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å•å…ƒ<code>nextUnitOfWork</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> nextUnitOfWork = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params">deadline</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> shouldYield = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) &#123;</span><br><span class="line">    nextUnitOfWork = <span class="title function_">performUnitOfWork</span>(</span><br><span class="line">      nextUnitOfWork</span><br><span class="line">    )</span><br><span class="line">    shouldYield = deadline.<span class="title function_">timeRemaining</span>() &lt; <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">requestIdleCallback</span>(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestIdleCallback</span>(workLoop)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">nextUnitOfWork</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬å››æ­¥ï¼šFibers"><a href="#ç¬¬å››æ­¥ï¼šFibers" class="headerlink" title="ç¬¬å››æ­¥ï¼šFibers"></a>ç¬¬å››æ­¥ï¼šFibers</h1><p>ä¸ºäº†åˆ†è§£ä»»åŠ¡å•å…ƒï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ•°æ®ç»“æ„ï¼š<code>fiber tree</code>ã€‚</p>
<p>ä¸€ä¸ª<code>fiber</code>å¯¹åº”ä¸€ä¸ªå…ƒç´ ï¼ŒåŒæ—¶æ¯ä¸ª<code>fiber</code>ä¹Ÿæ˜¯æˆ‘ä»¬æ‰€åˆ’åˆ†å‡ºæ¥çš„ä»»åŠ¡å•å…ƒã€‚</p>
<p>é‚£ä¹ˆ<code>fiber tree</code>åˆ°åº•æ˜¯é•¿å•¥æ ·çš„å‘¢ï¼Ÿ</p>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¦æ¸²æŸ“å¦‚ä¸‹ä¸€æ£µå…ƒç´ æ ‘ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Didact</span>.<span class="title function_">render</span>(</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">a</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">h2</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>,</span><br><span class="line">  container</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„<code>fiber tree</code>å°±é•¿ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚</p>
<p><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/fiber-tree.png" alt="fiber-tree.png"></p>
<p>åœ¨<code>render</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å…ˆåˆ›å»º<code>root fiber</code>å¹¶æŠŠå®ƒä½œä¸ºç¬¬ä¸€ä¸ªä»»åŠ¡å•å…ƒï¼Œå³ç¬¬ä¸€ä¸ª<code>nextUnitOfWork</code>ã€‚å…¶ä½™çš„ä»»åŠ¡ä¼šåœ¨<code>performUnitOfWork</code>è¿™ä¸ªæ–¹æ³•ä¸­å»å¤„ç†ã€‚å¯¹äºæ¯ä¸ª<code>fiber</code>æˆ‘ä»¬éœ€è¦åœ¨<code>performUnitOfWork</code>è¿™ä¸ªæ–¹æ³•ä¸­åšä¸‰ä»¶äº‹æƒ…ï¼š</p>
<ol>
<li>å°†å…ƒç´ è½¬æ¢ä¸ºèŠ‚ç‚¹å¹¶æ·»åŠ åˆ°<code>DOM</code>ä¸Šã€‚</li>
<li>ä¸ºè¯¥å…ƒç´ çš„å­å…ƒç´ <code>children</code>åˆ›å»º<code>fibers</code>ã€‚</li>
<li>è®¾ç½®ä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒ<code>nextUnitOfWork</code>ã€‚</li>
</ol>
<p><code>fiber tree</code>çš„å…¶ä¸­ä¸€ä¸ªç›®æ ‡å°±æ˜¯ä¸ºäº†èƒ½å¤Ÿè®©è®¾ç½®ä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒæ›´åŠ å®¹æ˜“ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ¯ä¸ªfiberéƒ½éœ€è¦æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼ˆé€»è¾‘ä¸Šï¼‰æŒ‡å‘ç¬¬ä¸€ä¸ªå­å…ƒç´ <code>child</code>ï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å…„å¼ŸèŠ‚ç‚¹<code>sibling</code>ï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘çˆ¶èŠ‚ç‚¹<code>parent</code>ã€‚</p>
<p>å½“æˆ‘ä»¬æ‰§è¡Œå®Œä¸€ä¸ª<code>fiber</code>çš„ä»»åŠ¡æ—¶ï¼Œå¦‚æœå®ƒçš„<code>child</code>æŒ‡é’ˆæŒ‡å‘çš„å…ƒç´ ä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™è¯¥å…ƒç´ å°†ä¼šè¢«æŒ‡å®šä¸º<code>nextUnitOfWork</code>ã€‚ä»¥ä¸Šå›¾ä¸­çš„<code>fiber tree</code>ä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œå®Œæ ‡ç­¾ä¸º<code>div</code>çš„<code>fiber</code>çš„ä»»åŠ¡æ—¶ï¼Œ<code>nextUnitOfWork</code>å°†ä¼šæ˜¯å®ƒçš„<code>child</code>æŒ‡é’ˆæŒ‡å‘çš„æ ‡ç­¾ä¸º<code>h1</code>çš„<code>fiber</code>ã€‚</p>
<p>å¦‚æœä¸€ä¸ª<code>fiber</code>çš„<code>child</code>æŒ‡é’ˆæŒ‡å‘çš„å…ƒç´ ä¸ºç©ºï¼Œå³è¯¥<code>fiber</code>ä¸å­˜åœ¨<code>child</code>æ—¶ï¼Œæˆ‘ä»¬å°†ä¼šæŒ‡å®š<code>sibling</code>å¯¹åº”çš„<code>fiber</code>ä½œä¸º<code>nextUnitOfWork</code>ã€‚è¿˜æ˜¯ä»¥ä¸Šå›¾çš„<code>fiber tree</code>ä¸ºä¾‹ï¼Œæ ‡ç­¾ä¸º<code>p</code>çš„<code>fiber</code>æ²¡æœ‰<code>child</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†<code>p</code>å¯¹åº”çš„<code>sibling</code>ï¼Œå³æ ‡ç­¾ä¸º<code>a</code>çš„<code>fiber</code>ä½œä¸º<code>nextUnitOfWork</code>ã€‚</p>
<p>å¦‚æœä¸€ä¸ª<code>fiber</code>å³æ²¡æœ‰<code>child</code>ä¹Ÿæ²¡æœ‰<code>sibling</code>ï¼Œæˆ‘ä»¬å°±æŒ‡å®š<code>nextUnitOfWork</code>ä¸ºè¯¥<code>fiber</code>çš„å”å”<code>uncle</code>ï¼Œå³è¯¥<code>fiber</code>çš„çˆ¶èŠ‚ç‚¹<code>parent</code>çš„å…„å¼ŸèŠ‚ç‚¹<code>sibling</code>ã€‚ä¸Šå›¾<code>fiber tree</code>ä¸­æ ‡ç­¾ä¸º<code>a</code>çš„<code>fiber</code>å°±æ²¡æœ‰<code>child</code>å’Œ<code>sibling</code>ï¼Œäºæ˜¯å‘ä¸Šå¯»æ‰¾æœ€åæ‰¾åˆ°äº†å®ƒçš„å”å”ï¼Œæ ‡ç­¾ä¸º<code>h2</code>çš„<code>fiber</code>ã€‚</p>
<p>å¦‚æœè¯¥<code>fiber</code>æ²¡æœ‰å”å”å‘¢ï¼Ÿæˆ‘ä»¬å°†ä¼šç»§ç»­æ²¿ç€<code>parent</code>å‘ä¸Šå¯»æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå­˜åœ¨siblingçš„parentæˆ–è€…åˆ°è¾¾æ ¹<code>root</code>ã€‚å¦‚æœæ˜¯åè€…çš„è¯ï¼Œé‚£å°±è¯´æ˜æˆ‘ä»¬å·²ç»æ‰§è¡Œå®Œäº†æœ¬æ¬¡æ¸²æŸ“<code>render</code>çš„æ‰€æœ‰ä»»åŠ¡ã€‚</p>
<p>æ¥ç€ï¼Œå°±è®©æˆ‘ä»¬æŠŠæƒ³æ³•è½¬æ¢ä¸ºä»£ç å§ã€‚</p>
<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°†<code>render</code>æ–¹æ³•ä¸­ä¹‹å‰çš„ä»£ç ç§»é™¤ï¼Œå¹¶å°†ç§»é™¤çš„é‚£éƒ¨åˆ†æ”¾åˆ°æ–¹æ³•<code>createDom</code>ä¸­å»ï¼Œè¿™å°†ä¼šåœ¨ä¹‹åç”¨åˆ°ã€‚</p>
<p>åŸ<code>render</code>æ–¹æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    element.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(element.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(element.<span class="property">props</span>)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = element.<span class="property">props</span>[name]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  element.<span class="property">props</span>.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">child</span> =&gt;</span></span><br><span class="line">    <span class="title function_">render</span>(child, dom)</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  container.<span class="title function_">appendChild</span>(dom)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¹é€ è¿‡åçš„<code>render</code>æ–¹æ³•ä»¥åŠ<code>createDom</code>æ–¹æ³•ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createDom</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dom =</span><br><span class="line">    fiber.<span class="property">type</span> == <span class="string">&quot;TEXT_ELEMENT&quot;</span></span><br><span class="line">      ? <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line">      : <span class="variable language_">document</span>.<span class="title function_">createElement</span>(fiber.<span class="property">type</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(fiber.<span class="property">props</span>)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = fiber.<span class="property">props</span>[name]</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> dom</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO set next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä¸“æ³¨äºå®ç°<code>render</code>æ–¹æ³•ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨<code>render</code>æ–¹æ³•ä¸­æˆ‘ä»¬å…ˆæŠŠ<code>fiber tree</code>çš„æ ¹<code>root</code>ä½œä¸º<code>nextUnitOfWork</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  nextUnitOfWork = &#123;</span><br><span class="line">    <span class="attr">dom</span>: container,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">children</span>: [element],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€å½“æµè§ˆå™¨æœ‰ç©ºçš„æ—¶å€™å°±ä¼šè°ƒç”¨æˆ‘ä»¬çš„ä»»åŠ¡å¾ªç¯<code>workLoop</code>ï¼Œæˆ‘ä»¬å°±ä¼šä»æ ¹<code>root</code>å¼€å§‹æ‰§è¡Œä»»åŠ¡ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params">deadline</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> shouldYield = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">while</span> (nextUnitOfWork &amp;&amp; !shouldYield) &#123;</span><br><span class="line">    nextUnitOfWork = <span class="title function_">performUnitOfWork</span>(</span><br><span class="line">      nextUnitOfWork</span><br><span class="line">    )</span><br><span class="line">    shouldYield = deadline.<span class="title function_">timeRemaining</span>() &lt; <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">requestIdleCallback</span>(workLoop)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">requestIdleCallback</span>(workLoop)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO add dom node</span></span><br><span class="line">  <span class="comment">// TODO create new fibers</span></span><br><span class="line">  <span class="comment">// TODO return next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>performUnitOfWork</code>ä¸­ï¼Œæˆ‘ä»¬è¦å…ˆä¸ºä¼ å…¥çš„<code>fiber</code>åˆ›å»ºå¯¹åº”çš„<code>DOM</code>èŠ‚ç‚¹ã€‚å¹¶ä¸”æˆ‘ä»¬ä¼šä½¿ç”¨<code>fiber.dom</code>å±æ€§æ¥å®šä½è¯¥<code>DOM</code>èŠ‚ç‚¹ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">parent</span>) &#123;</span><br><span class="line">    fiber.<span class="property">parent</span>.<span class="property">dom</span>.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// TODO create new fibers</span></span><br><span class="line">  <span class="comment">// TODO return next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯¹è¯¥<code>fiber</code>çš„å­å…ƒç´ <code>children</code>åˆ›å»ºç›¸åº”çš„<code>fiber</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  </span><br><span class="line">	...	</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">parent</span>: fiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// TODO return next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ ¹æ®æ˜¯å¦æ˜¯ç¬¬ä¸€ä¸ªå­å…ƒç´ æ¥è®¾ç½®<code>child</code>å’Œ<code>sibling</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  </span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    </span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// TODO return next unit of work</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œæˆ‘ä»¬æ ¹æ®ä¹‹å‰æåˆ°çš„<code>child-sibling-uncleï¼ˆparentâ€™s siblingï¼‰</code>çš„é¡ºåºæ¥æŒ‡å®šä¸€ä¸‹<code>nextUnitOfWork</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  </span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´çš„<code>performUnitOfWork</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">parent</span>) &#123;</span><br><span class="line">    fiber.<span class="property">parent</span>.<span class="property">dom</span>.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">parent</span>: fiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬äº”æ­¥ï¼šRender-and-Commit-Phases"><a href="#ç¬¬äº”æ­¥ï¼šRender-and-Commit-Phases" class="headerlink" title="ç¬¬äº”æ­¥ï¼šRender and Commit Phases"></a>ç¬¬äº”æ­¥ï¼šRender and Commit Phases</h1><p>è¿™é‡Œæˆ‘ä»¬åˆé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fiber.<span class="property">parent</span>) &#123;</span><br><span class="line">    fiber.<span class="property">parent</span>.<span class="property">dom</span>.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡æˆ‘ä»¬åœ¨å¤„ç†ä¸€ä¸ªå…ƒç´ æ—¶éƒ½éœ€è¦å°†å…¶æ–°å»ºçš„èŠ‚ç‚¹æ·»åŠ åˆ°<code>DOM</code>ä¸Šå»ã€‚ä½†æ˜¯ä¸è¦å¿˜äº†ï¼Œæµè§ˆå™¨èƒ½å¤Ÿåœ¨æˆ‘ä»¬æ¸²æŸ“å®Œæ•´æ£µ<code>fiber tree</code>ä¹‹å‰ä¸­æ–­æˆ‘ä»¬çš„æ¸²æŸ“è¿‡ç¨‹çš„ã€‚å‡ºç°è¿™ç§æƒ…å†µæ—¶ï¼Œç”¨æˆ·å°†ä¼šçœ‹åˆ°ä¸€ä¸ªä¸å®Œæ•´çš„UIç•Œé¢ï¼Œé‚£æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å°†ä¿®æ”¹<code>DOM</code>çš„è¿™éƒ¨åˆ†ä»£ç ä»<code>performUnitOfWork</code>æ–¹æ³•ä¸­ç§»é™¤ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">parent</span>: fiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›¸å¯¹åœ°ï¼Œæˆ‘ä»¬éœ€è¦ä¿æŒå¯¹<code>fiber tree</code>çš„æ ¹<code>root</code>çš„å¼•ç”¨ã€‚æˆ‘ä»¬å°†å…¶å¼•ç”¨å‘½åä¸º<code>wipRoot</code>ï¼ˆwork in progress rootï¼‰ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  wipRoot = &#123;</span><br><span class="line">    <span class="attr">dom</span>: container,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">children</span>: [element],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  nextUnitOfWork = wipRoot</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> nextUnitOfWork = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> wipRoot = <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>ä¸€æ—¦æˆ‘ä»¬å¤„ç†å®Œäº†æ‰€æœ‰ä»»åŠ¡å•å…ƒï¼ˆå¯ä»¥æ ¹æ®<code>nextUnitOfWork</code>æ˜¯å¦ä¸ºç©ºæ¥åˆ¤æ–­ï¼‰ï¼Œæˆ‘ä»¬å†å°†æ•´æ£µ<code>fiber tree</code>æäº¤åˆ°<code>DOM</code>ä¸Šã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// TODO add nodes to dom</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">workLoop</span>(<span class="params">deadline</span>) &#123;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!nextUnitOfWork &amp;&amp; wipRoot) &#123;</span><br><span class="line">    <span class="title function_">commitRoot</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>commitRoot</code>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä»¥é€’å½’çš„æ–¹å¼å°†æ‰€æœ‰èŠ‚ç‚¹æ·»åŠ åˆ°<code>DOM</code>ä¸Šã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">commitWork</span>(wipRoot.<span class="property">child</span>)</span><br><span class="line">  wipRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> domParent = fiber.<span class="property">parent</span>.<span class="property">dom</span></span><br><span class="line">  domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">child</span>)</span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">sibling</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬å…­æ­¥ï¼šReconciliation"><a href="#ç¬¬å…­æ­¥ï¼šReconciliation" class="headerlink" title="ç¬¬å…­æ­¥ï¼šReconciliation"></a>ç¬¬å…­æ­¥ï¼š<strong><strong>Reconciliation</strong></strong></h1><p>ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯å®ç°äº†æ·»åŠ èŠ‚ç‚¹åˆ°<code>DOM</code>ä¸Šï¼Œåˆ é™¤å’Œæ›´æ–°å‘¢ï¼Ÿ</p>
<p>è¿™å°±æ˜¯æœ¬èŠ‚è¦å®ç°çš„ç›®æ ‡ï¼Œä¸ºæ­¤æˆ‘ä»¬éœ€è¦å°†æœ¬æ¬¡æ¸²æŸ“çš„<code>fiber tree</code>å³<code>wipRoot</code>ä¸ä¸Šä¸€æ¬¡æäº¤åˆ°<code>DOM</code>ä¸Šçš„<code>fiber tree</code>è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>é‚£ä¹ˆï¼Œåœ¨æ¯æ¬¡æäº¤é˜¶æ®µå®Œæˆæ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¿æŒå¯¹æœ¬æ¬¡æäº¤åˆ°<code>DOM</code>ä¸Šçš„<code>fiber tree</code>çš„å¼•ç”¨ï¼Œä»¥æ–¹ä¾¿ä¸‹æ¬¡æ¯”è¾ƒï¼Œæˆ‘ä»¬å°†å…¶å¼•ç”¨å‘½åä¸º<code>currentRoot</code>ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¸ºæ¯ä¸ª<code>fiber</code>æ·»åŠ <code>alternate</code>å±æ€§ï¼ŒæŒ‡å‘æ—§çš„<code>fiber</code>ï¼Œå³åœ¨ä¸Šä¸ªæäº¤é˜¶æ®µæˆ‘ä»¬æ·»åŠ åˆ°<code>DOM</code>ä¸Šçš„<code>fiber</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">commitWork</span>(wipRoot.<span class="property">child</span>)</span><br><span class="line">  currentRoot = wipRoot</span><br><span class="line">  wipRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  wipRoot = &#123;</span><br><span class="line">    <span class="attr">dom</span>: container,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">children</span>: [element],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">alternate</span>: currentRoot,</span><br><span class="line">  &#125;</span><br><span class="line">  nextUnitOfWork = wipRoot</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentRoot = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œè®©æˆ‘ä»¬ä»<code>performUnitOfWork</code>æ–¹æ³•ä¸­æŠ½ç¦»åˆ›å»ºæ–°çš„<code>fiber</code>é‚£éƒ¨åˆ†ä»£ç ï¼ŒåŸä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">parent</span>: fiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      fiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†æŠ½ç¦»å‡ºæ¥çš„æ–¹æ³•æ”¾åˆ°<code>reconcileChildren</code>æ–¹æ³•ä¸­ï¼Œæ”¹é€ åçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, elements)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">wipFiber, elements</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (index &lt; elements.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> newFiber = &#123;</span><br><span class="line">      <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">      <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">parent</span>: wipFiber,</span><br><span class="line">      <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      wipFiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>reconcileChildren</code>è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ—§çš„<code>fiber</code>ä¸æ–°çš„å…ƒç´ è¿›è¡Œè°ƒå’Œ<code>reconclie</code>ã€‚</p>
<p>æˆ‘ä»¬åŒæ—¶è¿­ä»£æ—§<code>fiber</code>çš„å­å…ƒç´ <code>wipFiber.alternate</code>ä»¥åŠ<code>elements</code>æ•°ç»„ä¸­æˆ‘ä»¬æƒ³è¦è°ƒå’Œçš„å…ƒç´ ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬å¿½ç•¥åŒæ—¶è¿­ä»£é“¾è¡¨å’Œæ•°ç»„æ‰€éœ€è¦æ³¨æ„çš„é‚£äº›é€šç”¨ä»£ç ï¼Œåªå…³å¿ƒå…¶ä¸­æœ€é‡è¦çš„éƒ¨åˆ†ï¼š<code>oldFiber</code>å’Œ<code>element</code>ï¼Œ<code>element</code>æ˜¯æœ¬æ¬¡è°ƒå’Œæˆ‘ä»¬æƒ³è¦æ¸²æŸ“åˆ°<code>DOM</code>ä¸Šçš„<code>fiber</code>ï¼Œ<code>oldFiber</code>æ˜¯æˆ‘ä»¬ä¸Šæ¬¡æ¸²æŸ“åˆ°<code>DOM</code>ä¸Šçš„<code>fiber</code>ã€‚æˆ‘ä»¬éœ€è¦æ¯”è¾ƒå®ƒä»¬çš„å·®å¼‚ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">wipFiber, elements</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldFiber =</span><br><span class="line">    wipFiber.<span class="property">alternate</span> &amp;&amp; wipFiber.<span class="property">alternate</span>.<span class="property">child</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (</span><br><span class="line">    index &lt; elements.<span class="property">length</span> ||</span><br><span class="line">    oldFiber != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line">    <span class="keyword">let</span> newFiber = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO compare oldFiber to element</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      wipFiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹æ–¹å¼æ¥å¯¹å®ƒä»¬è¿›è¡Œæ¯”è¾ƒï¼š</p>
<ul>
<li>å¦‚æœ<code>oldFiber</code>å’Œ<code>element</code>çš„<code>type</code>ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä¿ç•™å…¶<code>DOM</code>èŠ‚ç‚¹ï¼Œåªæ›´æ–°å…¶ä¸­çš„å±æ€§<code>props</code>ã€‚</li>
<li>å¦‚æœå®ƒä»¬çš„typeä¸ä¸€æ ·ï¼š<ul>
<li>å¯¹äº<code>element</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºæ–°çš„<code>DOM</code>èŠ‚ç‚¹ã€‚</li>
<li>å¯¹äº<code>oldFiber</code>ï¼Œæˆ‘ä»¬éœ€è¦ç§»é™¤æ—§çš„<code>DOM</code>èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<blockquote>
<p>åœ¨çœŸæ­£çš„Reactä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨<code>key</code>æ¥ä¼˜åŒ–è°ƒå’Œã€‚æ¯”å¦‚ï¼Œå®ƒèƒ½å¤Ÿæ¢æµ‹åˆ°æ•°ç»„ä¸­å…ƒç´ çš„ä½ç½®æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reconcileChildren</span>(<span class="params">wipFiber, elements</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldFiber =</span><br><span class="line">    wipFiber.<span class="property">alternate</span> &amp;&amp; wipFiber.<span class="property">alternate</span>.<span class="property">child</span></span><br><span class="line">  <span class="keyword">let</span> prevSibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (</span><br><span class="line">    index &lt; elements.<span class="property">length</span> ||</span><br><span class="line">    oldFiber != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = elements[index]</span><br><span class="line">    <span class="keyword">let</span> newFiber = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sameType =</span><br><span class="line">      oldFiber &amp;&amp;</span><br><span class="line">      element &amp;&amp;</span><br><span class="line">      element.<span class="property">type</span> == oldFiber.<span class="property">type</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">      <span class="comment">// TODO update the node</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">      <span class="comment">// TODO add this node</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">      <span class="comment">// TODO delete the oldFiber&#x27;s node</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldFiber) &#123;</span><br><span class="line">      oldFiber = oldFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index === <span class="number">0</span>) &#123;</span><br><span class="line">      wipFiber.<span class="property">child</span> = newFiber</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      prevSibling.<span class="property">sibling</span> = newFiber</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    prevSibling = newFiber</span><br><span class="line">    index++</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>oldFiber</code>å’Œ<code>element</code>çš„<code>type</code>ä¸€è‡´æ—¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„<code>fiber</code>ï¼Œå…¶ä¸­ä¿æŒåŸæ¥çš„<code>DOM</code>ä¸å˜ï¼Œå±æ€§<code>props</code>é‡‡ç”¨<code>element.props</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (sameType) &#123;</span><br><span class="line">  newFiber = &#123;</span><br><span class="line">    <span class="attr">type</span>: oldFiber.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">    <span class="attr">dom</span>: oldFiber.<span class="property">dom</span>,</span><br><span class="line">    <span class="attr">parent</span>: wipFiber,</span><br><span class="line">    <span class="attr">alternate</span>: oldFiber,</span><br><span class="line">    <span class="attr">effectTag</span>: <span class="string">&#x27;UPDATE&#x27;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶æˆ‘ä»¬ä¸ºæ–°çš„<code>fiber</code>æ–°å¢äº†<code>effectTag</code>å±æ€§ã€‚è¿™ä¸ªå±æ€§æˆ‘ä»¬å°†ä¼šåœ¨åé¢çš„æäº¤é˜¶æ®µç”¨åˆ°ã€‚</p>
<p>å¯¹äº<code>type</code>ä¸ä¸€è‡´çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¸º<code>element</code>åˆ›å»ºæ–°çš„<code>fiber</code>ï¼Œå¹¶å°†<code>effectTag</code>è®¾ç½®ä¸º<code>PLACEMENT</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (element &amp;&amp; !sameType) &#123;</span><br><span class="line">	newFiber = &#123;</span><br><span class="line">	  <span class="attr">type</span>: element.<span class="property">type</span>,</span><br><span class="line">    <span class="attr">props</span>: element.<span class="property">props</span>,</span><br><span class="line">    <span class="attr">dom</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">parent</span>: wipFiber,</span><br><span class="line">    <span class="attr">alternate</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">effectTag</span>: <span class="string">&quot;PLACEMENT&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>oldFiber</code>ï¼Œæˆ‘ä»¬éœ€è¦åˆ é™¤å¯¹åº”çš„<code>node</code>ã€‚å› ä¸ºä¸ä¼šåˆ›å»ºæ–°çš„<code>fiber</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ—§çš„<code>fiber</code>ä¸Šè®¾ç½®<code>effectTag</code>ä¸º<code>DELETION</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldFiber &amp;&amp; !sameType) &#123;</span><br><span class="line">  oldFiber.<span class="property">effectTag</span> = <span class="string">&#x27;DELETION&#x27;</span>;</span><br><span class="line">  deletions.<span class="title function_">push</span>(oldFiber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯åœ¨æäº¤é˜¶æ®µçš„æ—¶å€™ï¼Œæˆ‘ä»¬æ“ä½œçš„<code>fiber tree</code>æ˜¯<code>wipRoot</code>ï¼Œå¹¶ä¸éœ€è¦æ—§çš„<code>fiber</code>ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦è®°ä½æˆ‘ä»¬éœ€è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼ˆé€šè¿‡<code>deletions</code>æ•°ç»„æ¥å­˜æ”¾ï¼‰ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params">element, container</span>) &#123;</span><br><span class="line">  wipRoot = &#123;</span><br><span class="line">    <span class="attr">dom</span>: container,</span><br><span class="line">    <span class="attr">props</span>: &#123;</span><br><span class="line">      <span class="attr">children</span>: [element],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">alternate</span>: currentRoot,</span><br><span class="line">  &#125;</span><br><span class="line">  deletions = []</span><br><span class="line">  nextUnitOfWork = wipRoot</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> deletions = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ï¼Œæˆ‘ä»¬åœ¨æäº¤é˜¶æ®µæ›´æ–°<code>DOM</code>æ—¶ï¼Œåªéœ€è¦æ“ä½œ<code>deletions</code>æ•°ç»„ä¸­çš„<code>fiber</code>å°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitRoot</span>(<span class="params"></span>) &#123;</span><br><span class="line">  deletions.<span class="title function_">forEach</span>(commitWork)</span><br><span class="line">  <span class="title function_">commitWork</span>(wipRoot.<span class="property">child</span>)</span><br><span class="line">  currentRoot = wipRoot</span><br><span class="line">  wipRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨ï¼Œå°±è®©æˆ‘ä»¬åœ¨<code>commitWork</code>æ–¹æ³•ä¸­æ ¹æ®<code>effectTag</code>æ¥å¯¹<code>DOM</code>è¿›è¡Œä¸åŒçš„æ“ä½œã€‚</p>
<p>å¦‚æœ<code>effectTag</code>æ˜¯<code>PLACEMENT</code>ï¼Œå°±åƒä¹‹å‰ä¸€æ ·ï¼Œå°†èŠ‚ç‚¹ç›´æ¥æ·»åŠ åˆ°<code>DOM</code>ä¸Šå³å¯ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> domParent = fiber.<span class="property">parent</span>.<span class="property">dom</span></span><br><span class="line">  domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;PLACEMENT&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">child</span>)</span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">sibling</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>effectTag</code>æ˜¯<code>DELETION</code>ï¼Œä¸<code>PLACEMENT</code>ç›¸åï¼Œæˆ‘ä»¬å°†èŠ‚ç‚¹ä»<code>DOM</code>ä¸Šç§»é™¤ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;PLACEMENT&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">effectTag</span> === <span class="string">&quot;DELETION&quot;</span>) &#123;</span><br><span class="line">    domParent.<span class="title function_">removeChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>effectTag</code>æ˜¯<code>UPDATE</code>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å·²å­˜åœ¨çš„<code>DOM</code>ä¸Šæ›´æ–°æ”¹å˜äº†çš„å±æ€§<code>props</code>ã€‚å› ä¸ºæ›´æ–°æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å°†å…·ä½“çš„å®ç°æ”¾åœ¨<code>updateDom</code>è¿™ä¸ªæ–¹æ³•ä¸­ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;PLACEMENT&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;UPDATE&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">updateDom</span>(</span><br><span class="line">      fiber.<span class="property">dom</span>,</span><br><span class="line">      fiber.<span class="property">alternate</span>.<span class="property">props</span>,</span><br><span class="line">      fiber.<span class="property">props</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">effectTag</span> === <span class="string">&quot;DELETION&quot;</span>) &#123;</span><br><span class="line">    domParent.<span class="title function_">removeChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateDom</span>(<span class="params">dom, prevProps, nextProps</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ–¹æ³•<code>updateDom</code>ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ¯”è¾ƒæ–°æ—§fiberçš„å±æ€§propsï¼Œåˆ é™¤æ—§çš„ï¼Œæ·»åŠ æ–°çš„ä»¥åŠå˜æ›´å€¼å‘ç”Ÿæ”¹å˜çš„ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt; key !== <span class="string">&quot;children&quot;</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isNew</span> = (<span class="params">prev, next</span>) =&gt; <span class="function"><span class="params">key</span> =&gt;</span></span><br><span class="line">  prev[key] !== next[key]</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isGone</span> = (<span class="params">prev, next</span>) =&gt; <span class="function"><span class="params">key</span> =&gt;</span> !(key <span class="keyword">in</span> next)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateDom</span>(<span class="params">dom, prevProps, nextProps</span>) &#123;</span><br><span class="line">  <span class="comment">// Remove old properties</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(prevProps)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="title function_">isGone</span>(prevProps, nextProps))</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set new or changed properties</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(nextProps)</span><br><span class="line">    .<span class="title function_">filter</span>(isProperty)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="title function_">isNew</span>(prevProps, nextProps))</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      dom[name] = nextProps[name]</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç­‰ç­‰ï¼Œè¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„å±æ€§æˆ‘ä»¬æ²¡æœ‰å¤„ç†ï¼Œé‚£å°±æ˜¯ç›‘å¬äº‹ä»¶ï¼Œåœ¨<code>React</code>ä¸­åˆæˆäº‹ä»¶æœ‰ä¸€ä¸ªç‰¹ç‚¹ï¼Œå°±æ˜¯ä»¥<code>on</code>å¼€å¤´ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬åœ¨<code>props</code>ä¸­è¯†åˆ«åˆ°ç›‘å¬äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶ç‰¹æ®Šå¤„ç†ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">isEvent</span> = key =&gt; key.<span class="title function_">startsWith</span>(<span class="string">&quot;on&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isProperty</span> = key =&gt;</span><br><span class="line">  key !== <span class="string">&quot;children&quot;</span> &amp;&amp; !<span class="title function_">isEvent</span>(key)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç›‘å¬äº‹ä»¶å‘ç”Ÿäº†æ”¹å˜ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒä»èŠ‚ç‚¹ä¸Šç§»é™¤ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateDom</span>(<span class="params">dom, prevProps, nextProps</span>) &#123;</span><br><span class="line">  <span class="comment">//Remove old or changed event listeners</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(prevProps)</span><br><span class="line">    .<span class="title function_">filter</span>(isEvent)</span><br><span class="line">    .<span class="title function_">filter</span>(</span><br><span class="line">      <span class="function"><span class="params">key</span> =&gt;</span></span><br><span class="line">        !(key <span class="keyword">in</span> nextProps) ||</span><br><span class="line">        <span class="title function_">isNew</span>(prevProps, nextProps)(key)</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventType = name</span><br><span class="line">        .<span class="title function_">toLowerCase</span>()</span><br><span class="line">        .<span class="title function_">substring</span>(<span class="number">2</span>)</span><br><span class="line">      dom.<span class="title function_">removeEventListener</span>(</span><br><span class="line">        eventType,</span><br><span class="line">        prevProps[name]</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æ–°çš„ç›‘å¬äº‹ä»¶æ·»åŠ åˆ°å¯¹åº”çš„èŠ‚ç‚¹ä¸Šå»ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateDom</span>(<span class="params">dom, prevProps, nextProps</span>) &#123;</span><br><span class="line">  <span class="comment">//Remove old or changed event listeners</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(prevProps)</span><br><span class="line">    .<span class="title function_">filter</span>(isEvent)</span><br><span class="line">    .<span class="title function_">filter</span>(</span><br><span class="line">      <span class="function"><span class="params">key</span> =&gt;</span></span><br><span class="line">        !(key <span class="keyword">in</span> nextProps) ||</span><br><span class="line">        <span class="title function_">isNew</span>(prevProps, nextProps)(key)</span><br><span class="line">    )</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventType = name</span><br><span class="line">        .<span class="title function_">toLowerCase</span>()</span><br><span class="line">        .<span class="title function_">substring</span>(<span class="number">2</span>)</span><br><span class="line">      dom.<span class="title function_">removeEventListener</span>(</span><br><span class="line">        eventType,</span><br><span class="line">        prevProps[name]</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// Add event listeners</span></span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">keys</span>(nextProps)</span><br><span class="line">    .<span class="title function_">filter</span>(isEvent)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="title function_">isNew</span>(prevProps, nextProps))</span><br><span class="line">    .<span class="title function_">forEach</span>(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> eventType = name</span><br><span class="line">        .<span class="title function_">toLowerCase</span>()</span><br><span class="line">        .<span class="title function_">substring</span>(<span class="number">2</span>)</span><br><span class="line">      dom.<span class="title function_">addEventListener</span>(</span><br><span class="line">        eventType,</span><br><span class="line">        nextProps[name]</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®ç°äº†æ›´æ–°å’Œåˆ é™¤ï¼Œè®©æˆ‘ä»¬åœ¨<a target="_blank" rel="noopener" href="https://codesandbox.io/s/didact-6-96533?file=/src/index.js">codesandbox</a>ä¸Šçœ‹çœ‹åŠ å…¥äº†è°ƒå’Œçš„<code>Didact</code>æ•ˆæœæ€ä¹ˆæ ·ã€‚</p>
<h1 id="ç¬¬ä¸ƒæ­¥ï¼šFunction-Components"><a href="#ç¬¬ä¸ƒæ­¥ï¼šFunction-Components" class="headerlink" title="ç¬¬ä¸ƒæ­¥ï¼šFunction Components"></a>ç¬¬ä¸ƒæ­¥ï¼š<strong><strong>Function Components</strong></strong></h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯è®©<code>Didact</code>æ”¯æŒå‡½æ•°ç»„ä»¶ã€‚</p>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ¢ä¸ªğŸŒ°ï¼Œä½¿ç”¨ä¸€ä¸ªç®€å•çš„å‡½æ•°ç»„ä»¶ï¼Œå…¶è¿”å›ä¸€ä¸ª<code>h1</code>å…ƒç´ ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> Didact.createElement */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hi &#123;props.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">App</span> <span class="attr">name</span>=<span class="string">&quot;foo&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> container = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>)</span><br><span class="line"><span class="title class_">Didact</span>.<span class="title function_">render</span>(element, container)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬å°†ä»¥ä¸Šçš„<code>JSX</code>è½¬æ¢ä¸º<code>JS</code>ï¼Œå°†ä¼šæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ï¼š</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(</span><br><span class="line">    <span class="string">&quot;h1&quot;</span>,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&quot;Hi &quot;</span>,</span><br><span class="line">    props.<span class="property">name</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> element = <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(<span class="title class_">App</span>, &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°ç»„ä»¶åœ¨ä¸¤ä¸ªæ–¹é¢æœ‰æ‰€ä¸åŒï¼š</p>
<ul>
<li>å‡½æ•°ç»„ä»¶çš„<code>fiber</code>æ²¡æœ‰ä¸ä¹‹å¯¹åº”çš„<code>DOM</code>èŠ‚ç‚¹ã€‚</li>
<li>å­å…ƒç´ <code>children</code>æ¥è‡ªè¿è¡Œçš„å‡½æ•°è€Œä¸æ˜¯ç›´æ¥ä»<code>props</code>é‡Œé¢è·å–ã€‚</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> elements = fiber.<span class="property">props</span>.<span class="property">children</span></span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, elements)</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ–¹æ³•<code>performUnitOfWork</code>åšå‡ºä¿®æ”¹ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥<code>fiber</code>çš„<code>type</code>æ˜¯å¦ä¸º<code>function</code>ï¼Œå¹¶ä»¥æ­¤ä¸ºä¾æ®æ¥åˆ¤æ–­æ˜¯å¦é‡‡ç”¨ä¸åŒçš„æ›´æ–°æ–¹æ³•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">performUnitOfWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> isFunctionComponent =</span><br><span class="line">    fiber.<span class="property">type</span> <span class="keyword">instanceof</span> <span class="title class_">Function</span></span><br><span class="line">  <span class="keyword">if</span> (isFunctionComponent) &#123;</span><br><span class="line">    <span class="title function_">updateFunctionComponent</span>(fiber)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">updateHostComponent</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">child</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> fiber.<span class="property">child</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> nextFiber = fiber</span><br><span class="line">  <span class="keyword">while</span> (nextFiber) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFiber.<span class="property">sibling</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> nextFiber.<span class="property">sibling</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextFiber = nextFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateHostComponent</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    fiber.<span class="property">dom</span> = <span class="title function_">createDom</span>(fiber)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, fiber.<span class="property">props</span>.<span class="property">children</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>updateHostComponent</code>æ–¹æ³•ä¸­ä½¿ç”¨åŸæ¥çš„æ›´æ–°æ–¹å¼ï¼Œè€Œåœ¨<code>updateFunctionComponent</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å…ˆæ‰§è¡Œè¿™ä¸ªå‡½æ•°å»è·å–å®ƒçš„å­å…ƒç´ ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> element = <span class="title class_">Didact</span>.<span class="title function_">createElement</span>(<span class="title class_">App</span>, &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>åœ¨æˆ‘ä»¬çš„ğŸŒ°ä¸­ï¼Œ<code>fiber.type</code>æŒ‡çš„å°±æ˜¯<code>App</code>è¿™ä¸ªå‡½æ•°ï¼Œå½“æˆ‘ä»¬è¿è¡Œå®ƒæ—¶ï¼Œå°±èƒ½ä»è¿”å›å€¼ä¸­è·å–å­å…ƒç´ <code>h1</code>ã€‚ä¸€æ—¦æˆ‘ä»¬è·å–åˆ°äº†å­å…ƒç´ ï¼Œå°±å¯ä»¥åƒä¹‹å‰ä¸€æ ·æ¥è¿›è¡Œè°ƒå’Œï¼Œä¸éœ€è¦åœ¨è¿™ä¸ªæ–¹æ³•ä¸­é¢å¤–åšå…¶ä»–äº‹æƒ…ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> children = [fiber.<span class="title function_">type</span>(fiber.<span class="property">props</span>)]</span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ—¢ç„¶ç°åœ¨æˆ‘ä»¬ä¼šé‡åˆ°æ²¡æœ‰<code>DOM</code>èŠ‚ç‚¹çš„<code>fiber</code>ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>commitWork</code>è¿™ä¸ªæ–¹æ³•ä¸­åšå‡ºä¸¤ç‚¹æ”¹å˜ã€‚</p>
<p>ç¬¬ä¸€ï¼Œæ²¿ç€<code>parent</code>æŒ‡é’ˆæ‰¾åˆ°ä¸€ä¸ª<code>DOM</code>èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ï¼Œç›´åˆ°æˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªå¸¦æœ‰DOMèŠ‚ç‚¹çš„<code>fiber</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!fiber) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> domParentFiber = fiber.<span class="property">parent</span></span><br><span class="line">  <span class="keyword">while</span> (!domParentFiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    domParentFiber = domParentFiber.<span class="property">parent</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> domParent = domParentFiber.<span class="property">dom</span>  </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;PLACEMENT&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;UPDATE&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">updateDom</span>(</span><br><span class="line">      fiber.<span class="property">dom</span>,</span><br><span class="line">      fiber.<span class="property">alternate</span>.<span class="property">props</span>,</span><br><span class="line">      fiber.<span class="property">props</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">effectTag</span> === <span class="string">&quot;DELETION&quot;</span>) &#123;</span><br><span class="line">    domParent.<span class="title function_">removeChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">child</span>)</span><br><span class="line">  <span class="title function_">commitWork</span>(fiber.<span class="property">sibling</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒï¼Œå½“åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œæˆ‘ä»¬åŒæ ·éœ€è¦æ²¿ç€<code>child</code>æŒ‡é’ˆï¼Œæ‰¾åˆ°ä¸€ä¸ªå¸¦æœ‰<code>DOM</code>èŠ‚ç‚¹çš„<code>fiber</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">commitWork</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  </span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;PLACEMENT&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    domParent.<span class="title function_">appendChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    fiber.<span class="property">effectTag</span> === <span class="string">&quot;UPDATE&quot;</span> &amp;&amp;</span><br><span class="line">    fiber.<span class="property">dom</span> != <span class="literal">null</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">updateDom</span>(</span><br><span class="line">      fiber.<span class="property">dom</span>,</span><br><span class="line">      fiber.<span class="property">alternate</span>.<span class="property">props</span>,</span><br><span class="line">      fiber.<span class="property">props</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fiber.<span class="property">effectTag</span> === <span class="string">&quot;DELETION&quot;</span>) &#123;</span><br><span class="line">    <span class="title function_">commitDeletion</span>(fiber, domParent)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">commitDeletion</span>(<span class="params">fiber, domParent</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (fiber.<span class="property">dom</span>) &#123;</span><br><span class="line">    domParent.<span class="title function_">removeChild</span>(fiber.<span class="property">dom</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">commitDeletion</span>(fiber.<span class="property">child</span>, domParent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ç¬¬å…«æ­¥ï¼šHooks"><a href="#ç¬¬å…«æ­¥ï¼šHooks" class="headerlink" title="ç¬¬å…«æ­¥ï¼šHooks"></a>ç¬¬å…«æ­¥ï¼šHooks</h1><p>æœ€åä¸€æ­¥ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»æœ‰äº†å‡½æ•°ç»„ä»¶ï¼Œè®©æˆ‘ä»¬ä¹ŸæŠŠ<code>state</code>åŠ è¿›æ¥å§ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Didact</span> = &#123;</span><br><span class="line">  createElement,</span><br><span class="line">  render,</span><br><span class="line">  useState,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@jsx</span> Didact.createElement */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = <span class="title class_">Didact</span>.<span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setState(c =&gt; c + 1)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">      Count: &#123;state&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> element = <span class="language-xml"><span class="tag">&lt;<span class="name">Counter</span> /&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>è®©æˆ‘ä»¬ä»¥ç»å…¸çš„è®¡æ•°å™¨ç»„ä»¶ä¸ºä¾‹ï¼Œæ¯ç‚¹å‡»å®ƒä¸€æ¬¡ï¼Œå®ƒçš„å€¼å°±å¢åŠ <code>1</code>ã€‚</p>
<p>æ³¨æ„è¿™é‡Œæˆ‘ä»¬å·²ç»æ›¿æ¢æˆäº†<code>Didact.useState</code>æ¥è·å–å¹¶æ›´æ–°è®¡æ•°å™¨çš„å€¼ã€‚</p>
<p>åœ¨æ–¹æ³•<code>updateFunctionComponent</code>ä¸­æˆ‘ä»¬ä¼šè°ƒç”¨<code>Counter</code>è¿™ä¸ªå‡½æ•°ç»„ä»¶ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬è¿˜ä¼šè°ƒç”¨<code>useState</code>æ–¹æ³•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> children = [fiber.<span class="title function_">type</span>(fiber.<span class="property">props</span>)]</span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initial</span>) &#123;</span><br><span class="line">  <span class="comment">// TODO</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è°ƒç”¨å‡½æ•°ç»„ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆåˆå§‹åŒ–å‡ ä¸ªå…¨å±€å˜é‡ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨<code>useState</code>æ–¹æ³•ä¸­ä½¿ç”¨å®ƒä»¬ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è®¾ç½®<code>wipFiber</code>ï¼ˆwork in process fiberï¼‰ã€‚ </p>
<p>åŒæ—¶ï¼Œä¸ºäº†å®ç°åœ¨åŒä¸€ä¸ªç»„ä»¶ä¸­èƒ½å¤Ÿè°ƒç”¨<code>useState</code>æ–¹æ³•å¤šæ¬¡ï¼Œæˆ‘ä»¬ä¸º<code>fiber</code>æ·»åŠ ä¸€ä¸ª<code>hooks</code>æ•°ç»„ã€‚å¹¶ä¸”æˆ‘ä»¬è®°å½•å½“å‰çš„<code>hook</code>ç´¢å¼•ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> wipFiber = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> hookIndex = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateFunctionComponent</span>(<span class="params">fiber</span>) &#123;</span><br><span class="line">  wipFiber = fiber</span><br><span class="line">  hookIndex = <span class="number">0</span></span><br><span class="line">  wipFiber.<span class="property">hooks</span> = []</span><br><span class="line">  <span class="keyword">const</span> children = [fiber.<span class="title function_">type</span>(fiber.<span class="property">props</span>)]</span><br><span class="line">  <span class="title function_">reconcileChildren</span>(fiber, children)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å‡½æ•°ç»„ä»¶è°ƒç”¨<code>useState</code>æ–¹æ³•æ—¶ï¼Œæˆ‘ä»¬å…ˆæ£€æŸ¥å…¶ä¸­æ˜¯å¦å­˜åœ¨æ—§çš„<code>hook</code>ã€‚å…·ä½“æ£€æŸ¥çš„æ–¹å¼æ˜¯é€šè¿‡<code>fiber</code>çš„<code>alternate</code>å±æ€§æ¥æ‰¾åˆ°æ—§çš„<code>fiber</code>ï¼Œå†é€šè¿‡<code>hookIndex</code>æ‰¾åˆ°æ—§<code>fiber</code>ä¸Šå¯¹åº”çš„<code>hook</code>ã€‚</p>
<p>å¦‚æœå­˜åœ¨æ—§çš„<code>hook</code>ï¼Œæˆ‘ä»¬ç›´æ¥ä»å…¶ä¸­å¤åˆ¶<code>state</code>åˆ°æ–°çš„<code>hook</code>ä¸­ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å…ˆåˆå§‹åŒ–<code>state</code>ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å°†æ–°çš„<code>hook</code>æ·»åŠ åˆ°<code>fiber</code>çš„<code>hooks</code>æ•°ç»„ä¸­å»ï¼Œå¹¶è®©ç´¢å¼•<code>hookIndex</code>å¢åŠ <code>1</code>ã€‚</p>
<p>æœ€åè¿”å›<code>state</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initial</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldHook =</span><br><span class="line">    wipFiber.<span class="property">alternate</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span>[hookIndex]</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;</span><br><span class="line">    <span class="attr">state</span>: oldHook ? oldHook.<span class="property">state</span> : initial,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wipFiber.<span class="property">hooks</span>.<span class="title function_">push</span>(hook)</span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">state</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>useState</code>æ–¹æ³•ä¹Ÿåº”è¯¥è¿”å›ä¸€ä¸ªç”¨æ¥æ›´æ–°<code>state</code>çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å®šä¹‰äº†<code>setState</code>æ–¹æ³•æ¥æ¥å—ä¸€ä¸ªåŠ¨ä½œ<code>action</code>ï¼ˆæ¯”å¦‚åœ¨è®¡æ•°å™¨ç»„ä»¶ä¸­è¿™ä¸ªåŠ¨ä½œå°±æ˜¯å¢åŠ <code>1</code>çš„æ–¹æ³•ï¼‰ã€‚æˆ‘ä»¬ä¸º<code>hook</code>æ–°å¢ä¸€ä¸ªé˜Ÿåˆ—<code>queue</code>ï¼Œå¹¶å°†<code>action</code>æ”¾å…¥å…¶ä¸­ã€‚</p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…å°±è·Ÿä¹‹å‰æˆ‘ä»¬åœ¨<code>render</code>æ–¹æ³•ä¸­æ‰€åšçš„ç±»ä¼¼ï¼ŒæŒ‡å®š<code>nextUnitOfWork</code>ä¸ºæ–°çš„<code>wipRoot</code>ï¼Œè¿™æ ·<code>workLoop</code>æ–¹æ³•å°±èƒ½å¤Ÿå¼€å¯ä¸€æ¬¡æ–°çš„æ¸²æŸ“é˜¶æ®µã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initial</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldHook =</span><br><span class="line">    wipFiber.<span class="property">alternate</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span>[hookIndex]</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;</span><br><span class="line">    <span class="attr">state</span>: oldHook ? oldHook.<span class="property">state</span> : initial,</span><br><span class="line">    <span class="attr">queue</span>: [],</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> <span class="title function_">setState</span> = action =&gt; &#123;</span><br><span class="line">    hook.<span class="property">queue</span>.<span class="title function_">push</span>(action)</span><br><span class="line">    wipRoot = &#123;</span><br><span class="line">      <span class="attr">dom</span>: currentRoot.<span class="property">dom</span>,</span><br><span class="line">      <span class="attr">props</span>: currentRoot.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">alternate</span>: currentRoot,</span><br><span class="line">    &#125;</span><br><span class="line">    nextUnitOfWork = wipRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wipFiber.<span class="property">hooks</span>.<span class="title function_">push</span>(hook)</span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">state</span>, setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œã€‚</p>
<p>æˆ‘ä»¬å°†ä¼šåœ¨ä¸‹æ¬¡æ¸²æŸ“è¿™ä¸ªç»„ä»¶çš„æ—¶å€™å†æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œï¼Œæˆ‘ä»¬ä¼šä»æ—§çš„<code>hook</code>ä¸Šçš„<code>queue</code>ä¸­è·å–æ‰€æœ‰çš„<code>action</code>ï¼Œå¹¶ä¸”ä¸€ä¸ªä¸€ä¸ªåœ°æ‰§è¡Œï¼Œè¿™æ ·åšä¹‹åï¼Œæˆ‘ä»¬è¿”å›çš„å·²ç»æ˜¯æ›´æ–°è¿‡çš„<code>state</code>ã€‚</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useState</span>(<span class="params">initial</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldHook =</span><br><span class="line">    wipFiber.<span class="property">alternate</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span> &amp;&amp;</span><br><span class="line">    wipFiber.<span class="property">alternate</span>.<span class="property">hooks</span>[hookIndex]</span><br><span class="line">  <span class="keyword">const</span> hook = &#123;</span><br><span class="line">    <span class="attr">state</span>: oldHook ? oldHook.<span class="property">state</span> : initial,</span><br><span class="line">    <span class="attr">queue</span>: [],</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> actions = oldHook ? oldHook.<span class="property">queue</span> : []</span><br><span class="line">  actions.<span class="title function_">forEach</span>(<span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    hook.<span class="property">state</span> = <span class="title function_">action</span>(hook.<span class="property">state</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setState</span> = action =&gt; &#123;</span><br><span class="line">    hook.<span class="property">queue</span>.<span class="title function_">push</span>(action)</span><br><span class="line">    wipRoot = &#123;</span><br><span class="line">      <span class="attr">dom</span>: currentRoot.<span class="property">dom</span>,</span><br><span class="line">      <span class="attr">props</span>: currentRoot.<span class="property">props</span>,</span><br><span class="line">      <span class="attr">alternate</span>: currentRoot,</span><br><span class="line">    &#125;</span><br><span class="line">    nextUnitOfWork = wipRoot</span><br><span class="line">    deletions = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wipFiber.<span class="property">hooks</span>.<span class="title function_">push</span>(hook)</span><br><span class="line">  hookIndex++</span><br><span class="line">  <span class="keyword">return</span> [hook.<span class="property">state</span>, setState]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬æ„å»ºäº†è‡ªå·±çš„<code>React</code>ã€‚</p>
<p>åœ¨<a target="_blank" rel="noopener" href="https://codesandbox.io/s/didact-8-21ost">codesandbox</a>æˆ–<a target="_blank" rel="noopener" href="https://github.com/pomber/didact">github</a>ä¸ŠæŸ¥çœ‹å®Œæ•´ä»£ç ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://ltanfr.github.io/blog-hexo-butterfly">ä¸åœ†</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://ltanfr.github.io/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/">https://ltanfr.github.io/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://ltanfr.github.io/blog-hexo-butterfly" target="_blank">æ˜¨æ—¥çš„é­”å¥³</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog-hexo-butterfly/tags/React/">React</a></div><div class="post_share"><div class="social-share" data-image="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/build-your-own-react.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://fastly.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/blog-hexo-butterfly/2022/05/07/js-again-type-conversion/"><img class="next-cover" src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/js-again.jpeg" onerror="onerror=null;src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">å†å­¦JSä¹‹ç±»å‹è½¬æ¢</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/avatar.jpeg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ä¸åœ†</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/blog-hexo-butterfly/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">9</div></a><a href="/blog-hexo-butterfly/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/blog-hexo-butterfly/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">5</div></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content"></div><div class="xpand" style="height:200px;"></div><canvas class="illo" width="800" height="800" style="max-width: 200px; max-height: 200px; touch-action: none; width: 640px; height: 640px;"></canvas></div><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople1.js"></script><script src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/zdog.dist.js"></script><script id="rendered-js" src="https://fastly.jsdelivr.net/gh/xiaopengand/blogCdn@latest/xzxr/twopeople.js"></script><style>.card-widget.card-announcement {
margin: 0;
align-items: center;
justify-content: center;
text-align: center;
}
canvas {
display: block;
margin: 0 auto;
cursor: move;
}</style><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Build-your-own-React"><span class="toc-text">Build your own React</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E9%9B%B6%E6%AD%A5%EF%BC%9A%E5%9B%9E%E9%A1%BE-JSX-to-JS"><span class="toc-text">ç¬¬é›¶æ­¥ï¼šå›é¡¾ JSX to JS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9AcreateElement"><span class="toc-text">ç¬¬ä¸€æ­¥ï¼šcreateElement</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9Arender"><span class="toc-text">ç¬¬äºŒæ­¥ï¼šrender</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9AConcurrent-Mode"><span class="toc-text">ç¬¬ä¸‰æ­¥ï¼šConcurrent Mode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9AFibers"><span class="toc-text">ç¬¬å››æ­¥ï¼šFibers</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9ARender-and-Commit-Phases"><span class="toc-text">ç¬¬äº”æ­¥ï¼šRender and Commit Phases</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E6%AD%A5%EF%BC%9AReconciliation"><span class="toc-text">ç¬¬å…­æ­¥ï¼šReconciliation</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E6%AD%A5%EF%BC%9AFunction-Components"><span class="toc-text">ç¬¬ä¸ƒæ­¥ï¼šFunction Components</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E6%AD%A5%EF%BC%9AHooks"><span class="toc-text">ç¬¬å…«æ­¥ï¼šHooks</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/" title="[è¯‘] Build your own React"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/build-your-own-react.jpg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="[è¯‘] Build your own React"/></a><div class="content"><a class="title" href="/blog-hexo-butterfly/2022/05/15/build-your-own-react-translate/" title="[è¯‘] Build your own React">[è¯‘] Build your own React</a><time datetime="2022-05-15T08:17:23.000Z" title="å‘è¡¨äº 2022-05-15 16:17:23">2022-05-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog-hexo-butterfly/2022/05/07/js-again-type-conversion/" title="å†å­¦JSä¹‹ç±»å‹è½¬æ¢"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/js-again.jpeg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="å†å­¦JSä¹‹ç±»å‹è½¬æ¢"/></a><div class="content"><a class="title" href="/blog-hexo-butterfly/2022/05/07/js-again-type-conversion/" title="å†å­¦JSä¹‹ç±»å‹è½¬æ¢">å†å­¦JSä¹‹ç±»å‹è½¬æ¢</a><time datetime="2022-05-07T01:26:11.000Z" title="å‘è¡¨äº 2022-05-07 09:26:11">2022-05-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog-hexo-butterfly/2022/05/06/js-again-primitive-type-object/" title="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” object"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/js-again.jpeg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” object"/></a><div class="content"><a class="title" href="/blog-hexo-butterfly/2022/05/06/js-again-primitive-type-object/" title="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” object">å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” object</a><time datetime="2022-05-06T11:46:33.000Z" title="å‘è¡¨äº 2022-05-06 19:46:33">2022-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog-hexo-butterfly/2022/05/06/rxjs-first-sight/" title="åˆè§ RxJS"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/rxjs-first-sight.jpeg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="åˆè§ RxJS"/></a><div class="content"><a class="title" href="/blog-hexo-butterfly/2022/05/06/rxjs-first-sight/" title="åˆè§ RxJS">åˆè§ RxJS</a><time datetime="2022-05-06T07:10:16.000Z" title="å‘è¡¨äº 2022-05-06 15:10:16">2022-05-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/blog-hexo-butterfly/2022/05/06/js-again-primitive-type-bigint-symbol/" title="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” bigintã€symbol"><img src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/js-again.jpeg" onerror="this.onerror=null;this.src='https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/img/404.jpg'" alt="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” bigintã€symbol"/></a><div class="content"><a class="title" href="/blog-hexo-butterfly/2022/05/06/js-again-primitive-type-bigint-symbol/" title="å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” bigintã€symbol">å†å­¦ JS ä¹‹æ•°æ®ç±»å‹ â€”â€” bigintã€symbol</a><time datetime="2022-05-06T02:20:04.000Z" title="å‘è¡¨äº 2022-05-06 10:20:04">2022-05-06</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 <i id="heartbeat" class="fa fas fa-heartbeat"></i> ä¸åœ†</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Tan's Playground</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/js/utils.js"></script><script src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/js/main.js"></script><script src="https://fastly.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://fastly.jsdelivr.net/npm/instant.page@5/instantpage.min.js" type="module"></script><script src="https://fastly.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://fastly.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'Evh69tEP3Y1wU2thKai1cR7T-gzGzoHsz',
      appKey: 'd2EytL03yjlvMtHWz4VWOkrU',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://fastly.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas id="universe"></canvas><script defer src="https://fastly.jsdelivr.net/gh/ltanfr/blog-hexo-butterfly@gh-pages/js/universe.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://fastly.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>